<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="ss1.css">
	<script src="https://unpkg.com/phosphor-icons"></script>
	<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
	

	<title>User Address Tab</title>
</head>
<body>
	<div class="app">
		<header class="app-header">
			<div class="app-header-logo">
				<div class="logo">
					<span class="logo-icon">
						<img src="/images/logo.png" />
					</span>
					<h1 class="logo-title">
						<span>Heel_Drive</span>
						<span>Shoes</span>
					</h1>
				</div>
			</div>
			<div class="app-header-navigation">
				<div class="tabs">
					<a href="userproducts.html">
						Products
					</a>
					<a href="useraddress.html" class="active">
						Address
					</a>
					<a href="userorder.html">
						Orders
					</a>
					<a href="usercart.html">
						Cart
					</a>
					<a href="userprofile.html">
						Your Profile
					</a>
				</div>
			</div>
			
			<div id="mapDiv" style="
            align-items: center;
            text-align: center;
            display: none; position: absolute; background-color: rgb(50, 50, 50); height: 300px; width: 400px; top: 150px; right: 0; z-index: 2;">
                <div class="tabs" style="display: block;">
					<a href="userproducts.html" class="active">
						Products
					</a><br>
					<a href="useraddress.html">
						Address
					</a><br>
					<a href="userorder.html">
						Orders
					</a><br>
					<a href="usercart.html">
						Cart
					</a><br>
					<a href="userprofile.html">
						Your Profile
					</a>
				</div>
            </div>
            
			<div class="app-header-actions">
				<button class="user-profile">
					<span id="usname"></span>
					<span>
						<img src="" id="usprofile"/>
					</span>
				</button>
				<div class="app-header-actions-buttons">
				</div>
			</div>
			<div class="app-header-mobile">
				<button class="icon-button large" onclick="showmap()">
					<i class="ph-list"></i>
				</button>
			</div>
	
		</header>
		<div class="app-body">
			<div class="app-body-navigation">
				<nav class="navigation">
					<a href="userproducts.html">
						<i class="ph-browsers"></i>
						<span>Products</span>
					</a>
					<a href="useraddress.html">
						<i class="ph ph-house"></i>
						<span>Address</span>
					</a>
					<a href="usercart.html">
						<i class="ph ph-credit-card"></i>
						<span>Cart</span>
					</a>
					<a href="userorder.html">
						<i class="ph ph-user"></i>
						<span>Orders</span>
					</a>
					<a href="userprofile.html">
						<i class="ph ph-bag"></i>
						<span>Your Profile</span>
					</a>
					<a href="userlogout.html">
						<i class="ph ph-package"></i>
						<span>Logout</span>
					</a>
				</nav>
				<footer class="footer">
					<h1>Heel Drive<small>Â©</small></h1>
					<div>
						Heel Drive Â©<br />
						All Rights Reserved 2025
					</div>
				</footer>
			</div>
			<div class="app-body-main-content">
                <section class="service-section">
                    <div class="transfer-section-header">
                        <h2>Address Details</h2>
                        <div class="filter-options">
                            <p>Filter selected: more than 100 $</p>
                            <button class="icon-button" title="Logout" onclick="logout()">
                                <i class="ph ph-sign-out"></i>
                            </button>
                            <button class="icon-button">
                                <i class="ph-plus"></i>
                            </button>
                        </div>
                    </div>
                    <div class="tiles">
                        <article style="height: 260px; max-width: 800px; overflow-y: scroll;" id="addressblock">
                            <div class="addresscard" style="width: 100%; background: transparent; padding: 10px; border-radius: 8px; box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.1);">
                                <label class="addresstype" style="font-size: 24px;">Home</label><br>
                                <label class="addressline">1400 Maple St</label><br>
                                <label class="city">San Francisco</label><br>
                                <label class="state">CA</label><br>
                                <label class="zipcode">94101</label><br>
                                <label class="country">USA</label><br>
                                <label class="isdefault">Yes</label><br>
                                <label class="createdat">2024-03-06</label>
								<button class="icon-button" style="width: 200px; border-radius: 0; margin-top: 20px;">Select This</button>
                            </div>
							<script>
							
							function getQueryParam(param) {
							    const urlParams = new URLSearchParams(window.location.search);
							    return urlParams.get(param);
							  }

							  // Retrieve values
							  const productId = getQueryParam("productId");
							  const price = getQueryParam("price");
							  const quantity = getQueryParam("quantity");
							  const amount = getQueryParam("amount");
							  //console.log("single ", productId,price,quantity, amount );
							  
							  const cartsString = getQueryParam("Carts");
							  const carts = JSON.parse(decodeURIComponent(cartsString));  // Convert back to object
							  console.log("Carts Data:", carts);
							  
							  let addressid;
							  let userId;
								
							let filteredAddresses = []; // Global variable to store addresses

							function fetchAddresses() {
							    fetch('/api/address') // Update this with your actual API endpoint
							        .then(response => response.json())
							        .then(addresses => {
							            console.log(addresses);
							            // Filter only addresses where userId is 2
							            filteredAddresses = addresses.filter(address => address.userid === userId);
							            
							            console.log(filteredAddresses); // Debugging - Check the filtered addresses
							            
							            Address(); // Populate UI dynamically
							        })
							        .catch(error => console.error("Error fetching addresses:", error));
							}

							function Address() {
							    const ss = document.getElementById("addressblock");
							    ss.innerHTML = "";

							    filteredAddresses.forEach(address => {
							        const addressDiv = document.createElement('div');
							        addressDiv.classList.add('addresscard');

							        addressDiv.innerHTML = `
							            <label class="addresstype" style="font-size: 24px;">${address.addresstype}</label><br>
							            <label class="addressline">${address.addressline}</label><br>
							            <label class="city">${address.city}</label><br>
							            <label class="state">${address.state}</label><br>
							            <label class="zipcode">${address.zipcode}</label><br>
							            <label class="country">${address.country}</label><br>
							            <label class="isdefault">${address.isdefault}</label><br>
							            <label class="createdat">${address.createdat}</label>
							            <button class="icon-button" style="width: 200px; border-radius: 0; margin-top: 20px; margin-bottom: 20px;" onclick="showPaymentPopup(${address.id})">Select This</button>
							        `;

							        ss.appendChild(addressDiv);
							    });
							}

							function showPaymentPopup(addressid) {
							    const popup = document.createElement("div");
							    popup.style.cssText = "position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1); border-radius: 0px; text-align: center; width: 300px;";
							    
							    popup.innerHTML = `
							        <p style='font-size: 18px; margin-bottom: 20px;'>Choose Payment Method</p>
							        <button class='button' onclick='redirectToPayment(${productId}, ${price}, ${quantity}, ${addressid})'> <i class="ph ph-money"></i> Cash on Delivery</button>
							        <button class='button1'onclick='proceedToPayment(${productId}, ${price}, ${quantity}, ${addressid})'> <i class="ph ph-credit-card"></i> Online Payment</button>
							        <br>
							        <button style='margin-top: 20px; padding: 5px 10px; background: red; color: white; border: none; cursor: pointer; border-radius: 4px;' onclick='closePopup(this)'>Cancel</button>
							    `;
							    document.body.appendChild(popup);
							}


							function redirectToPayment(productId, productAmount, quantity, addressId) {
							    if (productId == undefined && productAmount == undefined && quantity == undefined){
							        const productRequests = carts.map(item =>
							        fetch(`/getProduct/${item.productid}`)
							            .then(response => response.json())
							            .then(productData => ({
							                productId: item.productid,
							                quantity: item.quantity,
							                perUnitPrice: productData.offer_price,
							                totalPrice: productData.offer_price * item.quantity
							            }))
							        );

							        Promise.all(productRequests)
							            .then(cartItems => {
							                const newAmount = cartItems.reduce((sum, item) => sum + item.totalPrice, 0);

							                return fetch("http://localhost:8081/api/order", {
							                    method: "POST",
							                    headers: { "Content-Type": "application/json" },
							                    body: JSON.stringify({
							                        userid: userId,
							                        addressid: addressId,
							                        status: "Pending",
							                        totalprice: newAmount,
							                        paymentstatus: "Pending(COD)",
							                        createdat: new Date().toISOString().split("T")[0]
							                    })
							                })
							                .then(res => res.json())
							                .then(order => {
							                    const orderId = order.id;
							                    const orderItemsData = cartItems.map(item => ({
							                        orderid: orderId,
							                        productid: item.productId,
							                        quantity: item.quantity,
							                        perunitprice: item.perUnitPrice,
							                        totalprice: item.totalPrice
							                    }));

							                    return Promise.all(orderItemsData.map(item =>
							                        fetch("http://localhost:8081/api/orderitem", {
							                            method: "POST",
							                            headers: { "Content-Type": "application/json" },
							                            body: JSON.stringify(item)
							                        }).then(res => res.json())
							                    )).then(() => ({ orderId, newAmount }));
							                });
							            })
							            .then(({ orderId, newAmount }) => {
							                const paymentData = {
							                    orderid: orderId,
							                    userid: userId,
							                    razorpaypaymentid: "cashondelivery",
							                    razorpayorderid: "cashondelivery",
							                    razorpaysignature: "cashondelivery",
							                    amount: newAmount,
							                    status: "Pending(COD)",
							                    createdat: new Date().toISOString().split("T")[0]
							                };

							                return fetch("http://localhost:8081/api/payments/payment", {
							                    method: "POST",
							                    headers: { "Content-Type": "application/json" },
							                    body: JSON.stringify(paymentData)
							                })
							                .then(res => res.json());
							            })
							            .then(() => {
							                return Promise.all(carts.map(item =>
							                    fetch(`/api/cart/${item.id}`, {
							                        method: "DELETE"
							                    })
							                ));
							            })
							            .then(() => {
							                alert("ðŸŽ‰ Order placed successfully!");
							                //window.location.href = "orders.html";
							            })
							            .catch(err => {
							                console.error("âŒ Error in order processing:", err);
							                alert("Something went wrong during order placement.");
							            });

							    }
							    else{
							    	
							    	
							    	console.log("Single Product Purchase:", productId, productAmount, quantity);


							    	const newAmount = productAmount * quantity;
							    	console.log("ðŸ’° Total Amount (COD):", newAmount);

							    	// Step 1: Create Order
							    	fetch("http://localhost:8081/api/order", {
							    	    method: "POST",
							    	    headers: { "Content-Type": "application/json" },
							    	    body: JSON.stringify({
							    	        userid: userId,
							    	        totalprice: newAmount,
							    	        status: "Pending",
							    	        paymentstatus: "Pending(COD)",
							    	        addressid: addressId,
							    	        createdat: new Date().toISOString().split("T")[0]
							    	    })
							    	})
							    	.then(response => {
							    	    if (!response.ok) throw new Error("Failed to create order");
							    	    return response.json();
							    	})
							    	.then(order => {
							    	    console.log("âœ… Order Created:", order);
							    	    const orderId = order.id;

							    	    // Step 2: Store Order Item
							    	    return fetch("http://localhost:8081/api/orderitem", {
							    	        method: "POST",
							    	        headers: { "Content-Type": "application/json" },
							    	        body: JSON.stringify({
							    	            orderid: orderId,
							    	            productid: productId,
							    	            quantity: quantity,
							    	            perunitprice: productAmount,
							    	            totalprice: newAmount
							    	        })
							    	    }).then(response => {
							    	        if (!response.ok) throw new Error("Failed to store order item");
							    	        return response.json();
							    	    }).then(orderItem => {
							    	        console.log("âœ… Order Item Stored:", orderItem);

							    	        // Step 3: Store Payment Info (COD)
							    	        const paymentData = {
							    	            orderid: orderId,
							    	            userid: userId,
							    	            razorpaypaymentid: "cashondelivery",
							    	            razorpayorderid: "cashondelivery",
							    	            razorpaysignature: "cashondelivery",
							    	            amount: newAmount,
							    	            status: "Pending(COD)",
							    	            createdat: new Date().toISOString().split("T")[0]
							    	        };

							    	        return fetch("http://localhost:8081/api/payments/payment", {
							    	            method: "POST",
							    	            headers: { "Content-Type": "application/json" },
							    	            body: JSON.stringify(paymentData)
							    	        });
							    	    });
							    	})
							    	.then(response => {
							    	    if (!response.ok) throw new Error("Failed to store payment data");
							    	    return response.json();
							    	})
							    	.then(paymentResponse => {
							    	    console.log("âœ… COD Payment Info Stored:", paymentResponse);
							    	    alert("ðŸŽ‰ Order placed successfully with Cash on Delivery!");
							    	    //window.location.href = "orders.html"; // Redirect to orders page
							    	})
							    	.catch(error => {
							    	    console.error("âŒ Error during order process:", error);
							    	    alert("Something went wrong. Please try again.");
							    	});

							    	
							    	
							    	
							    }
							}

							function closePopup(button) {
							    document.body.removeChild(button.parentElement);
							}

							
							function proceedToPayment(productId, productAmount, quantity, addressId) {
								
								if (productId == undefined && productAmount == undefined && quantity == undefined) { 
									
									// Step 1: Fetch product details and calculate newAmount
									console.log("two ");

									//console.log(productRequests);
									const productRequests = carts.map(item =>
									    fetch(`/getProduct/${item.productid}`)
									        .then(response => response.json())
									        .then(productData => ({
									            productId: item.productid,
									            quantity: item.quantity,
									            perUnitPrice: productData.offer_price,
									            totalPrice: productData.offer_price * item.quantity
									        }))
									);

									Promise.all(productRequests)
									    .then(cartItems => {
									        console.log("âœ… Product Details Fetched:", cartItems);

									        // Calculate total amount (newAmount)
									        const newAmount = cartItems.reduce((sum, item) => sum + item.totalPrice, 0);
									        console.log("ðŸ’° Total Amount (newAmount):", newAmount);

									        // Step 2: Create Order
									        return fetch("http://localhost:8081/api/order", {
									            method: "POST",
									            headers: { "Content-Type": "application/json" },
									            body: JSON.stringify({
									                userid: userId,
									                addressid: addressId,
									                status: "Pending",
									                totalprice: newAmount,
									                paymentstatus: "pending",
									                createdat: new Date().toISOString().split("T")[0]
									            })
									        })
									        .then(response => {
									            if (!response.ok) throw new Error("Failed to create order");
									            return response.json();
									        })
									        .then(order => {
									            console.log("âœ… Order Created:", order);
									            const orderId = order.id;

									            console.log("Step 3: Storing Order Items...");

									            // Store Order Items
									            const orderItemsData = cartItems.map(item => ({
									                orderid: orderId,
									                productid: item.productId,
									                quantity: item.quantity,
									                perunitprice: item.perUnitPrice,
									                totalprice: item.totalPrice
									            }));

									            console.log("ðŸš€ Sending Order Items:", orderItemsData);

									            // Send each order item separately and wait for all requests to complete
									            return Promise.all(
									                orderItemsData.map(item =>
									                    fetch("http://localhost:8081/api/orderitem", {
									                        method: "POST",
									                        headers: { "Content-Type": "application/json" },
									                        body: JSON.stringify(item)
									                    })
									                    .then(response => {
									                        if (!response.ok) throw new Error("Failed to save order item");
									                        return response.json();
									                    })
									                )
									            )
									            .then(orderItems => {
									                console.log("âœ… Order Items Stored:", orderItems);
									                return { orderId, newAmount }; // Pass orderId and newAmount to the next step
									            })
									            .catch(error => {
									                console.error("âŒ Error storing order items:", error);
									            });

									        });
									    })
									    .then(({ orderId, newAmount }) => {
									        console.log("Step 4: Creating Razorpay Order...");

									        return fetch(`http://localhost:8081/api/payments/create-order?amount=${newAmount}&currency=INR`, {
									            method: "POST"
									        })
									        .then(response => {
									            if (!response.ok) throw new Error("Failed to create Razorpay order");
									            return response.json();
									        })
									        .then(razorpayOrder => {
									            console.log("âœ… Razorpay Order Created:", razorpayOrder);
									            if (!razorpayOrder.id) throw new Error("Invalid Razorpay order response");

									            // Step 5: Open Razorpay Payment Gateway
									            console.log("Step 5: Opening Razorpay Payment Gateway...");

									            const options = {
									                key: "rzp_test_fpzCQ26MqHo9GM", // Razorpay API Key
									                amount: newAmount * 100, // Convert to paise
									                currency: "INR",
									                name: "Your Company",
									                description: "Product Purchase",
									                order_id: razorpayOrder.id,
									                handler: function (response) {
									                    console.log("âœ… Payment Successful:", response);

									                    console.log("Step 6: Storing Payment Data...");

									                    // Step 6: Store Payment Data
									                    const paymentData = {
									                        orderid: orderId,
									                        userid: userId,
									                        razorpaypaymentid: response.razorpay_payment_id,
									                        razorpayorderid: response.razorpay_order_id,
									                        razorpaysignature: response.razorpay_signature,
									                        amount: newAmount,
									                        status: "success",
									                        createdat: new Date().toISOString().split("T")[0]
									                    };

									                    return fetch("http://localhost:8081/api/payments/payment", {
									                        method: "POST",
									                        headers: { "Content-Type": "application/json" },
									                        body: JSON.stringify(paymentData)
									                    })
									                    .then(response => {
									                        if (!response.ok) throw new Error("Failed to save payment details");
									                        return response.json();
									                    })
									                    .then(paymentResponse => {
									                        console.log("âœ… Payment Data Stored:", paymentResponse);

									                        console.log("Step 7: Updating Order Payment Status...");

									                        // Step 7: Update Order Payment Status to "Paid"
									                        return fetch(`http://localhost:8081/api/order/${orderId}`, {
									                            method: "PUT",
									                            headers: { "Content-Type": "application/json" },
									                            body: JSON.stringify({ paymentstatus: "paid" })
									                        })
									                        .then(response => {
									                            if (!response.ok) throw new Error("Failed to update order status");
									                            return response.json();
									                        })
									                        .then(updateResponse => {
									                            console.log("âœ… Order Payment Status Updated:", updateResponse);

									                            console.log("Step 8: Deleting Cart Items...");

									                            // Send DELETE request for each cart item
									                            return Promise.all(
									                                carts.map(item =>
									                                    fetch(`http://localhost:8081/api/cart/${item.id}`, {
									                                        method: "DELETE"
									                                    })
									                                    .then(response => {
									                                        if (!response.ok) throw new Error(`Failed to delete cart item with ID: ${item.id}`);
									                                    })
									                                )
									                            )
									                            .then(() => {
									                                console.log("âœ… All Cart Items Deleted Successfully!");
									                                alert("ðŸŽ‰ Order placed successfully!");
									                                paymentRec(paymentData);
									                                //window.location.href = "userorders.html"; // Redirect to orders page
									                            })
									                            .catch(error => {
									                                console.error("âŒ Error deleting cart items:", error);
									                                alert("Order placed, but some cart items could not be deleted.");
									                            });
									                        })

									                    });
									                }
									            };

									            const rzp = new Razorpay(options);
									            rzp.open();
									        });
									    })
									    .catch(err => {
									        console.error("âŒ Error:", err);
									        alert("Something went wrong, please try again.");
									    });

								}
								else{
									
									console.log("single ", productId,price,quantity, amount );
									const newAmount = productAmount * quantity; // Calculate total amount
									
								    console.log("Step 1: Creating Order in Database...");
	
								    // Step 1: Create Order in Database
								    fetch("http://localhost:8081/api/order", {
								        method: "POST",
								        headers: { "Content-Type": "application/json" },
								        body: JSON.stringify({
								            userid: userId,
								            totalprice: newAmount,
								            status: "Pending",
								            paymentstatus: "Pending", // Initially unpaid
								            addressid: addressId,
								            createdat: new Date().toISOString().split("T")[0]
								        })
								    })
								    .then(response => {
								        if (!response.ok) throw new Error("Failed to create order");
								        return response.json();
								    })
								    .then(order => {
								        console.log("âœ… Order Created:", order);
								        const orderId = order.id;
	
								        console.log("Step 2: Storing Order Items...");
	
								        // Step 2: Store Order Items
								        return fetch("http://localhost:8081/api/orderitem", {
								            method: "POST",
								            headers: { "Content-Type": "application/json" },
								            body: JSON.stringify({
								                orderid: orderId,
								                productid: productId,
								                quantity: quantity,
								                perunitprice: productAmount,
								                totalprice: newAmount
								            })
								        }).then(response => {
								            if (!response.ok) throw new Error("Failed to save order items");
								            return response.json();
								        }).then(orderItems => {
								            console.log("âœ… Order Items Saved:", orderItems);
								            return orderId; // Pass orderId to next step
								        });
								    })
								    .then(orderId => {
								        console.log("Step 3: Creating Razorpay Order...");
	
								        // Step 3: Create Razorpay Order
								        return fetch(`http://localhost:8081/api/payments/create-order?amount=${newAmount}&currency=INR`, {
								            method: "POST"
								        }).then(response => {
								            if (!response.ok) throw new Error("Failed to create Razorpay order");
								            return response.json();
								        }).then(razorpayOrder => {
								            console.log("âœ… Razorpay Order Created:", razorpayOrder);
								            if (!razorpayOrder.id) throw new Error("Invalid Razorpay order response");
	
								            // Step 4: Open Razorpay Payment Gateway
								            console.log("Step 4: Opening Razorpay Payment Gateway...");
	
								            const options = {
								                key: "rzp_test_fpzCQ26MqHo9GM", // Razorpay API Key
								                amount: newAmount * 100, // Convert to paise
								                currency: "INR",
								                name: "Your Company",
								                description: "Product Purchase",
								                order_id: razorpayOrder.id,
								                handler: function (response) {
								                    console.log("âœ… Payment Successful:", response);
	
								                    console.log("Step 5: Storing Payment Data...");
	
								                    // Step 5: Store Payment Data
								                    const paymentData = {
								                        orderid: orderId,  // Use orderId created earlier
								                        userid: userId,
								                        razorpaypaymentid: response.razorpay_payment_id,
								                        razorpayorderid: response.razorpay_order_id,
								                        razorpaysignature: response.razorpay_signature,
								                        amount: newAmount,
								                        status: "success",
								                        createdat: new Date().toISOString().split("T")[0]
								                    };
	
								                    return fetch("http://localhost:8081/api/payments/payment", {
								                        method: "POST",
								                        headers: { "Content-Type": "application/json" },
								                        body: JSON.stringify(paymentData)
								                    })
								                    .then(response => {
								                        if (!response.ok) throw new Error("Failed to save payment details");
								                        return response.json();
								                    })
								                    .then(paymentResponse => {
								                        console.log("âœ… Payment Data Stored:", paymentResponse);
	
								                        console.log("Step 6: Updating Order Payment Status...");
	
								                        // Step 6: Update Order Payment Status to "Paid"
								                        return fetch(`http://localhost:8081/api/order/${orderId}`, {
								                            method: "PUT",
								                            headers: { "Content-Type": "application/json" },
								                            body: JSON.stringify({ paymentstatus: "paid" })
								                        })
								                        .then(response => {
								                            if (!response.ok) throw new Error("Failed to update order status");
								                            return response.json();
								                        })
								                        .then(updateResponse => {
								                            console.log("âœ… Order Payment Status Updated:", updateResponse);
								                            
								                            //console.log("user name", )
								                            paymentRec(paymentData);
	
								                            alert("ðŸŽ‰ Order placed successfully!");
								                            //window.location.href = "orders.html"; // Redirect to orders page
								                        });
								                    });
								                }
								            };
	
								            const rzp = new Razorpay(options);
								            rzp.open();
								        });
								    })
								    .catch(err => {
								        console.error("âŒ Error:", err);
								        alert("Something went wrong, please try again.");
								    });
								}
								
							}
							
							
							
							
							async function paymentRec(Payment) {
							    //console.log(Payment);

							    const reuser = Payment.userid;
							    const reorder = Payment.orderid;
							    
							    
							    let reamount = Payment.amount;
							    let redate = Payment.createdat;
							    let retc = Payment.razorpaysignature;
							    let restatus = Payment.status;

							    const productNames = await getProductNamesFromOrder(reorder);
							    

							    let username = ''; // declared immediately after reuser/reorder
							    let usermail = '';
							    let usermobile = '';
							    
							    

							    try {
							        const response = await fetch(`/api/getUsers/${reuser}`);
							        if (!response.ok) {
							            throw new Error('Network response was not ok');
							        }

							        const data = await response.json();
							        
							        //console.log(data);
							        username = data.username;
							        usermail = data.email;
							        usermobile = data.phone;

							        // Continue logic here using username and reorder
							    } catch (error) {
							        console.error('Fetch error:', error);
							    }
							    
							    //console.log(username, usermail, usermobile, reamount, redate, retc, restatus, productNames)
							    
							    const receipt = {
							        customer: {
							            name: username,
							            email: usermail,
							            phone: usermobile
							        },
							        order: {
							            amount: reamount,
							            date: redate,
							            transactionCode: retc,
							            status: restatus,
							            products: productNames // array of product names
							        }
							    };

							    console.log('Final Receipt Object:', receipt);
							    
							    printReceipt(receipt)
							    
							}


							async function getProductNamesFromOrder(orderId) {
							    try {
							    	
							    	console.log("or id", orderId)
							        // Step 1: Fetch all order items
							        const itemsResponse = await fetch('/api/orderitem');
							        if (!itemsResponse.ok) {
							            throw new Error('Failed to fetch order items');
							        }

							        const allItems = await itemsResponse.json();
									
							        console.log("iteams", allItems)
							        // Step 2: Filter by this orderId
							        
							        const orderItems = allItems.filter(item => `${item.orderid}` == orderId);
							        console.log("or", `${allItems.orderid}`)
							        console.log("or", orderItems)
							        // Step 3: Extract product IDs
							        const productIds = orderItems.map(item => item.productid);
							        console.log("pro", productIds)
							        
							        //console.log(productIds)

							        // Step 4: Fetch all product details in parallel
							        const productFetches = productIds.map(id =>
							            fetch(`/getProduct/${id}`).then(res => {
							                if (!res.ok) throw new Error(`Failed to fetch product ${id}`);
							                return res.json();
							            })
							        );
							        
							        
							        console.log("pro fetch", productFetches)

							        // Wait for all product fetches to complete
							        const products = await Promise.all(productFetches);
							        
							        console.log("final pro fetch", products)

							        // Step 5: Extract product names
							        const productNames = products.map(product => product.product_name);
							        
							        console.log("final pro name", productNames)

							        //console.log('Product Names:', productNames);
							        return productNames;
							    } catch (error) {
							        console.error('Error in fetching product names:', error);
							        return [];
							    }
							}






							function printReceipt(payment) {
							    const receiptHTML = `
							<!DOCTYPE html>
							<html>
							<head>
							  <title>Receipt - ${payment.customer.name}</title>
							  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet" />
							  <style>
							    body {
							      font-family: 'Roboto', Arial, sans-serif;
							      padding: 40px;
							      background: #f9f9f9;
							      color: #333;
							    }
							    .container {
							      max-width: 800px;
							      background: white;
							      padding: 40px;
							      margin: auto;
							      box-shadow: 0 0 15px rgba(0,0,0,0.1);
							      border-radius: 12px;
							    }
							    .header {
							      display: flex;
							      justify-content: space-between;
							      align-items: center;
							      border-bottom: 2px solid #eee;
							      padding-bottom: 20px;
							    }
							    .header img {
							      height: 60px;
							    }
							    .company {
							      text-align: right;
							      font-size: 14px;
							      font-weight: 400;
							      color: #666;
							    }
							    .company strong {
							      font-weight: 700;
							      color: #222;
							    }
							    h2 {
							      font-weight: 700;
							      color: #2c3e50;
							      margin-top: 40px;
							      margin-bottom: 20px;
							    }
							    table.details {
							      width: 200px;
							      border-collapse: collapse;
							      margin-top: 10px;
							    }
							    table.details th, table.details td {
							      width: 100px;
							      border: 1px solid #ddd;
							      padding: 10px 15px;
							      text-align: left;
							    }
							    table.details tr td{
							    	min-width: 10px;
							    }
							    
							    table.details th {
							      background-color: #f2f2f2;
							      font-weight: 700;
							      width: 150px;
							    }
							    .total {
							      margin-top: 30px;
							      font-size: 22px;
							      color: #e74c3c;
							      font-weight: 700;
							      text-align: right;
							    }
							    .footer {
							      margin-top: 60px;
							      font-size: 13px;
							      text-align: center;
							      color: #999;
							    }
							  </style>
							</head>
							<body>
							  <div class="container">
							    <div class="header">
							      <img src="/logo.png" alt="Logo">
							      <div class="company">
							        <strong>Heel Drive</strong><br>
							        Shoe Store<br>
							        Contectme@HeelDrive.com
							      </div>
							    </div>

							    <h2>Receipt</h2>

							    <table class="details">
							      <tr>
							        <th>User Name</th>
							        <td>${payment.customer.name}</td>
							      </tr>
							      <tr>
							        <th>Email</th>
							        <td>${payment.customer.email}</td>
							      </tr>
							      <tr>
							        <th>Phone No</th>
							        <td>${payment.customer.phone}</td>
							      </tr>
							      <tr>
							      <th>Payment</th>
							      <td>${payment.order.status}</td>
							    </tr>
							    <tr>
							      <th>transaction Id</th>
							      <td style="font-size: 12px;">${payment.order.transactionCode}</td>
							    </tr>
							    <tr>
							      <th>All Products</th>
							      <td>${payment.order.products.join(', ')}</td>
							    </tr>
							    <tr>
							      <th>Order Date</th>
							      <td>${payment.order.date}</td>
							    </tr>
							    </table>

							    <p class="total">Amount Paid: $${payment.order.amount}</p>

							    <div class="footer">
							      Thank you for your payment!<br>
							      Page 1 of 1
							    </div>
							  </div>
							</body>
							</html>
							`;

							    const win = window.open('', '', 'width=800,height=600');
							    if (!win) {
							      alert("Please allow popups for this site to print the receipt.");
							      return;
							    }
							    win.document.write(receiptHTML);
							    win.document.close();
							    win.focus();
							    win.print();
							    win.close();
							}










							// Fetch addresses when the page loads
							//fetchAddresses();

							</script>
                        </article>
                        <article>
                            <select name="addresstype" id="addresstype" class="user-search" style="margin-top: 15px; height: 45px; width: 300px;">
							  <option value="">Select Address Type</option>
							  <option value="Home">Home</option>
							  <option value="Office">Office</option>		
							  <option value="Other">Other</option>					  
							</select>
							<input type="text" class="user-search" placeholder="addressline" style="margin-top: 15px; height: 45px; width: 300px;">
							<input type="text" class="user-search" placeholder="city" style="margin-top: 15px; height: 45px; width: 300px;">
							<input type="text" class="user-search" placeholder="state" style="margin-top: 15px; height: 45px; width: 300px;">
							<input type="text" class="user-search" placeholder="zipcode" style="margin-top: 15px; height: 45px; width: 300px;">
							<input type="text" class="user-search" placeholder="country" style="margin-top: 15px; height: 45px; width: 300px;">
							<select name="isdefault" id="itsdefault" class="user-search" style="margin-top: 15px; height: 45px; width: 300px;">
							  <option value="">Select It's Default Address</option>
							  <option value="true">Yes</option>
							  <option value="false">No</option>							  
							</select>
                            <button class="icon-button" style="width: 300px; border-radius: 0; margin-top: 20px;" id="add-ad">Add New</button>
                        </article>
						<script>
							const addButton = document.getElementById('add-ad');

							addButton.addEventListener('click', addNewAddress);

							function addNewAddress() {
							if (filteredAddresses.length >= 4) {
								alert("You can only have a maximum of 4 addresses.");
								return;
							}
							
							const newAddress = {
									addresstype: document.getElementById("addresstype").value,
							        addressline: document.querySelector('input[placeholder="addressline"]').value,
							        city: document.querySelector('input[placeholder="city"]').value,
							        state: document.querySelector('input[placeholder="state"]').value,
							        zipcode: document.querySelector('input[placeholder="zipcode"]').value,
							        country: document.querySelector('input[placeholder="country"]').value,
							        isdefault: document.getElementById("itsdefault").value,
							        createdat: new Date().toISOString().split('T')[0],
							        userid: userId
							};
							
							
							
							
							fetch(`/api/address`, { 
									method: "POST",
									headers: {
						                "Content-Type": "application/json"
						            },
						            body: JSON.stringify(newAddress)
					             })
		                    .then(response => {
		                        if (response.ok) {
		                            alert('Address Added successfully');
		                            filteredAddresses.push(newAddress);
									Address();
		                        } else {
		                            alert('Error Adding Address');
		                        }
		                    })
		                    .catch(error => console.error('Error Adding Address:', error));
							
							
							
							//filteredAddresses.push(newAddress);
							//Address();
						}
							
							
							let userdata = {};

					    	  async function fetchUserInfo() {
					    	    try {
					    	      const adminRes = await fetch('/api/userinfo');

					    	      if (!adminRes.ok) {
					    	        throw new Error('Failed to fetch admin info');
					    	      }

					    	      const data = await adminRes.json();

					    	      
					    	      // Update DOM
					    	      document.getElementById("usname").innerText = data.name;
					    	      document.getElementById("usprofile").src = `/api/getUserImage/${data.id}`;

					    	      console.log("User Data:", data);

					    	    } catch (error) {
					    	      console.error('Error fetching admin data:', error.message);
					    	    }
					    	  }
					    	  fetchUserInfo();
							
							function showmap() {
						          const mapDiv = document.getElementById("mapDiv");
						          if (mapDiv.style.display === "none" || mapDiv.style.display === "") {
						              mapDiv.style.display = "block";
						          } else {
						              mapDiv.style.display = "none";
						          }
						      }
							
							window.addEventListener('DOMContentLoaded', () => {
					  			fetch('/api/userinfo')
					  		    .then(res => {
					  		      if (res.ok) return res.json();
					  		      else throw new Error('Not User');
					  		    })
					  		    .then(user => {
					  		      // User is logged in
					  		      console.log("Logged in as User:", user.id);
					  		    userId = `${user.id}`;
					  		    fetchAddresses();

					  		      //window.location.href = `/usersingleproduct.html?id=${loc}`;
					  		    })
					  		    .catch(() => {
					  		      // Neither admin nor user logged in
					  		      alert("Not logged in. Redirecting to login page.");
					  		      window.location.href = '/userlogin.html';
					  		    });
					  		});

							
							function logout() {
								  fetch('/api/logout', {
								    method: 'POST',
								    credentials: 'include'  // Important to send session cookie
								  })
								    .then(res => {
								      if (res.ok) return res.text();
								      else throw new Error('Logout failed');
								    })
								    .then(() => {
								      window.location.href = '/userlogin.html';
								    })
								    .catch(() => {
								      alert("Not logged in. Redirecting to login page.");
								      window.location.href = '/userlogin.html';
								    });
								}
							  
						</script>
                    </div>
                </section>
            </div>
			<div class="app-body-sidebar">
			</div>
		</div>
	</div>
</body>
</html>

<style>
    .status-active {
	color: green;
	font-weight: bold;
}
.status-inactive {
	color: red;
	font-weight: bold;
}

@media (min-width: 1025px) and (max-width: 1600px){ 
	.service-section{
		width: 1000px;
	}
	.service-section table{
		width: 1000px;
	}
	
	.tiles{
		width: 1070px;
	}
}

@media (min-width: 426px) and (max-width: 768px){ 
	
	.tiles article{
		width: 300px;
	}
}
@media (min-width: 769px) and (max-width: 1024px){ 
	
	.tiles article{
		width: 300px;
	  /* background: red; */
	}
}
.button, .button1 {
    position: relative;
    display: flex;
    align-items: center;
    gap: 8px;
    color: black;
    border: none;
    padding: 12px 24px;
	margin-top: 20px;
	margin-left: 20px;
    font-size: 16px;
    font-weight: bold;
    border-radius: 30px;
    cursor: pointer;
    overflow: hidden;
    transition: box-shadow 0.3s ease-in-out, color 0.3s ease-in-out;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
}

/* Default Colors for Mobile */
.button {
    background: rgb(34, 197, 94); /* Green */
}

.button1 {
    background: rgb(0, 102, 255); /* Blue */
}

/* Laptop/Desktop Hover Effect */
@media (min-width: 1024px) {
    .button, .button1 {
        background: transparent; /* Reset background for transition */
    }

    .button::before, .button1::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 23%; /* Start with 10% color */
        height: 100%;
        transition: width 0.4s ease-in-out;
        z-index: -1;
    }

    /* Green transition for .button */
    .button::before {
        background: rgb(34, 197, 94);
    }

    /* Blue transition for .button1 */
    .button1::before {
        background: rgb(0, 102, 255);
    }

    /* Expand effect on hover */
    .button:hover::before, .button1:hover::before {
        width: 100%;
    }

    .button:hover, .button1:hover {
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
        color: white;
    }
}


</style>